---
title: 'Visualización Graficos Barra'
author: "Elisa Salas"
date: "28 de mayo 2021"
output:
  html_document: default
  pdf_document:
    toc: no
  word_document:
    toc: no
---

```{r setup, include=FALSE}
# Este es el chunk de setup, opciones generales de chunks, se recomienda!

knitr::opts_chunk$set(cache=FALSE, # guarda renderizaciones parciales, ahorra tiempo
                      warning = FALSE, # evita publicar advertencias
                      message = FALSE) # evita publicar mensajes

Sys.setlocale("LC_ALL","ES_ES.UTF-8") # para temas de caracteres en español, recomendable
```

```{r library, include=FALSE}
library(stringr)
library(tidyverse)
library(broom)
library(cowplot)
library(ggplot2)
```

```{r bbdd, include=FALSE}
rm(list = ls())

# BBDD LONG
load("~/Desktop/ELSOC/dataverse_files/Datasets/ELSOC_Long_2016_2019_labelled_v2.00.RData")

#BBDD WIDE
load("~/Desktop/ELSOC/dataverse_files/Datasets/ELSOC_Wide_2016_2019_v1.00_R.RData")

# Definir NA
elsoc_long_2016_2019[elsoc_long_2016_2019==-999 | elsoc_long_2016_2019==-888] <- NA
elsoc_wide_2016_2019[elsoc_wide_2016_2019 == -888 | elsoc_wide_2016_2019 == -999] <- NA

#Label Olas
elsoc_long_2016_2019$ola <- factor(elsoc_long_2016_2019$ola,labels = c('2016', '2017', '2018', '2019'))
```

En este instructivo aprenderá a realizar gráficos de barra más complejos para datos longitudinales. Esta sección elabora análisis para graficar tres o más variables en un mismo gráfico. 

Paso 1: Seleccionar y recodificar las variables que se analizarán

- Rellenar nombre de variable *[VARIABLE]* y cada una de sus categorias *[CAT_n]*
```{r Paso 1, echo=TRUE}
#Ejemplo: Actualmente en Chile, ¿Cuán importante es para surgir en la vida…?
#[VARIABLE_1 = d05_01] y [CAT_n = 'Nada', 'Poco', 'Algo', 'Bastante', 'Mucho']
#categoría de edad
elsoc_long_2016_2019$edad <- factor(car::recode(elsoc_long_2016_2019$m0_edad, "18:29=1;30:49=2;50:64=3;65:150=4"),
                        labels = c('18-29', '30-49', '50-64', '65 o más'))
#categoría de zona
elsoc_long_2016_2019$zona  <- car::recode(elsoc_long_2016_2019$region,"c('Tarapaca','Antofagasta','Atacama','Coquimbo','Arica')= 1;c('Valparaiso','Lib. Gral. B. Ohiggins','B. Ohiggins', 'Maule','Bio Bio')= 2;c('Araucania','Los Lagos','Aysen','Magallanes','Los Rios')=3 ;'Metropolitana'= 4")
elsoc_long_2016_2019$zona  <- factor(elsoc_long_2016_2019$zona,levels=c("1","2","3","4"), labels = c("Norte","Centro","Sur","Metropolitana"))
```

Paso 2: Crear una tabla simplificada que agrupa la variable a analizar por otra variable de interés

- Rellenar nombre de variable de interés *[VARIABLE]* y agurpación de interés *[VAR_Z]*
```{r tabla_datos_gráfico, eval=FALSE, include=FALSE}
#No logré hacer el loop. SOS.
vars <- c('d05_01', 'd05_02', 'd05_03', 'd05_04')
for(i in vars) {
  datos_vars(i) <- elsoc_long_2016_2019 %>% 
    dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>% 
    dplyr::filter(!is.na(i)) %>% 
    group_by((i), m0_sexo, ola) %>% 
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>% 
    group_by(ola) %>%
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>%
    ungroup() 
}  
```

```{r version_larga, eval=FALSE, include=FALSE}
datos_01 <- elsoc_long_2016_2019 %>% 
    dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>% 
    dplyr::filter(!is.na(d05_01)) %>% 
    group_by(d05_01, m0_sexo, edad, ola) %>% 
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>% 
    group_by(ola, m0_sexo, edad) %>%
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>%
    ungroup() 
datos_02 <- elsoc_long_2016_2019 %>% 
    dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>% 
    dplyr::filter(!is.na(d05_02)) %>% 
    group_by(d05_02, m0_sexo, edad, ola) %>% 
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>% 
    group_by(ola, m0_sexo, edad) %>%
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>%
    ungroup() 
datos_03 <- elsoc_long_2016_2019 %>% 
    dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>% 
    dplyr::filter(!is.na(d05_03)) %>% 
    group_by(d05_03, m0_sexo, edad, ola) %>% 
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>% 
    group_by(ola, m0_sexo, edad) %>%
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>%
    ungroup() 
datos_04 <- elsoc_long_2016_2019 %>% 
    dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>% 
    dplyr::filter(!is.na(d05_04)) %>% 
    group_by(d05_04, m0_sexo, edad, ola) %>% 
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>% 
    group_by(ola, m0_sexo, edad) %>%
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>%
    ungroup() 
```

Paso 3: Revisar la tabla recién creada
```{r revisión, eval=FALSE, include=FALSE}
datos.grafico <- elsoc_long_2016_2019 %>% 
    dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>% 
    dplyr::filter(!is.na(c05_08)) %>% 
    group_by(c05_08, m0_sexo, edad, ola) %>% 
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>% 
    group_by(ola, m0_sexo, edad) %>%
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>%
    ungroup() 
```

Luego de hacer esos 3 pasos, se realizan 5 tipos de gráfico que relacionan las variables:

(1) Variables categóricas de interés *[VARIABLE_n]*

(2) Variable que agrupa (ej: ola, tramo de edad, sexo, ciudad, zona, etc..) *[VAR_Z]*

## Grafico de Barras por cada variable X = 'Categoría'
```{r creo que final}
datos.grafico <- elsoc_long_2016_2019 %>% 
        dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>% 
        dplyr::select(ola, ponderador02, starts_with('d05_')) %>% 
        lapply(sticky::unsticky) %>% data.frame() %>% 
        pivot_longer(cols = starts_with('d05_'))  %>%
        mutate(variable = factor(name,
                             labels = c(' Provenir de una familia rica o con muchos recursos', ' Tener un buen nivel de educación', ' Tener ambición', ' El trabajo duro')),
           respuesta = case_when(value == 1 | value == 2 ~ 'Nada o Poco Importante',
                                 value == 3  ~ 'Algo Importante',
                                 value == 4 | value == 5 ~ 'Bastante o Muy Importante')) %>% 
    group_by(ola, variable, respuesta) %>% 
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>% 
    dplyr::filter(!is.na(respuesta)) %>% 
    group_by(ola, variable) %>% 
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>% 
    ungroup()
```

```{r graficando}
datos.subset <- droplevels(subset(datos.grafico, datos.grafico$respuesta == 'Bastante o Muy Importante'))

datos.subset %>% 
    ggplot(aes(y = porcentaje, x = ola, fill = variable, 
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
    geom_col(width = 0.5, position = "dodge2") +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
    facet_grid(.~variable) + 
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position="none") +
    ggtitle('Responde "Bastante o Muy Importante" según año')
```


