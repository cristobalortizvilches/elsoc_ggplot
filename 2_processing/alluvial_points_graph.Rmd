---
title: "Visualización Gráficos Alluvial y Puntos"
author: "Cristóbal Ortiz"
date: "28-05-2021"
output: html_document
---

```{r library, include=FALSE}
library(pacman)
pacman::p_load(stringr,tidyverse,broom,cowplot,ggplot2,survey)
```

```{r Cargar BBDD}
remove(list = ls())
getwd()
load("../1_input/data/elsoc_long.RData")
```
```{r}
elsoc_diseno <- svydesign(ids = ~idencuesta,strata = ~estrato,weights = ~ponderador02,nest = TRUE,data = elsoc_long)

datos2.1 <- data.frame(prop.table((svytable(~idpart + ola,elsoc_diseno,round = T)))) 

names(datos2.1)


```

```{r gráfico alluvial 2.1: idnull 2 olas}
ggplot(elsoc_long, aes(x = ola, fill = idpart, stratum = idpart, 
               alluvium = idencuesta, y = Freq)) +
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(data = datos2.1, 
              aes(label = scales::percent(porcentaje, accuracy = .1)),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2.75,
              color = rep('white')) +
    ggtitle('Cambio de frecuencias de indentificación con coalición política según año')
```

#2.1 Alluvial para cuatro olas: identificación con coalición política


```{r gráfíco alluvial 2.2: idpol 4 olas}
ggplot(datos2.2, aes(x = ola, fill = idpol, stratum = idpol, 
               alluvium = idencuesta, y = porcentaje)) +
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.grafico2.2, 
              aes(label = scales::percent(porcentaje, accuracy = .1)),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2.75,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias de indentificación con coalición política según año')
```

#2.3 Alluvial para dos o más categorías: situación ocupacional

```{r gráfico alluvial 2.3: socup por sexo}
ggplot(datos2.3, aes(x = ola, fill = socup, stratum = socup, 
               alluvium = idencuesta, y = porcentaje)) +
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    facet_grid(.~m0_sexo)+
    geom_text(data = etiquetas.grafico2.3, 
              aes(label = scales::percent(porcentaje, accuracy = .1)),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2.75,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias en situación ocupacional para hombres y mujeres')
```


#3.1 Lineas y puntos 

```{r}
ggplot(etiquetas.grafico3.1,aes(y = porcentaje, x = ola, color = cambiar_consti, group = cambiar_consti,
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
    geom_line(size = 1) +
    geom_point(size = 1.8) +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, .4)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_color_viridis_d(begin = .2, end = .5, direction = 1, option = 'viridis') +
    geom_text(vjust = -0.8,
    posilinetion = position_dodge(width = .9),
    size= 2.75) +
    theme(legend.position = 'top',
          legend.title = element_blank())
```

