---
title: "Visualización Gráficos Alluvial y Puntos"
author: "Cristóbal Ortiz"
date: "28-05-2021"
output: html_document
---

```{r library, include=FALSE}
library(pacman)
pacman::p_load(stringr,tidyverse,broom,cowplot,ggplot2)
```

```{r Cargar BBDD}
# BBDD LONG
getwd()
load("../1_input/data/ELSOC_Long_2016_2019_labelled_v2.00.RData")

#BBDD WIDE
#load("1_input/data/ELSOC_Wide_2016_2019_v1.00_R.RData")

# Definir NA
elsoc_long_2016_2019[elsoc_long_2016_2019==-999 | elsoc_long_2016_2019==-888] <- NA
#elsoc_wide_2016_2019[elsoc_wide_2016_2019==-888 | elsoc_wide_2016_2019==-999] <- NA

#Label Olas
elsoc_long_2016_2019$ola <- factor(elsoc_long_2016_2019$ola,labels = c('2016', '2017', '2018', '2019'))
```

#2.1 Alluvial para dos olas: identificación/no indentificación con partido o coalición política
```{r datos alluvial 2.1: idnull 2 olas}
datos2.1 <- elsoc_long_2016_2019 %>% 
    dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>%
  mutate(idpart = factor(c16,
                          labels = c('PC','PH','RD','PRO','EVO','PPD','AMP','PDC','PRI','RN','UDI','PS','PRDS','Otro','Ninguno'))) %>%
  mutate(idcoal = factor(c17,
                          labels = c('Chile Vamos','Nueva Mayoría','Frente Amplio', 'Otra','Ninguna'))) %>%
    dplyr::filter(!is.na(idpart)) %>%
    dplyr::filter(!is.na(idcoal)) %>%
    group_by(idencuesta,idpart,idcoal,ola) %>%
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>%
    group_by(ola) %>%
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>%
    ungroup()

datos2.1$idnull <- factor(datos2.1$idpart == 'Ninguno' & datos2.1$idcoal == 'Ninguna',
                               levels = c(FALSE, TRUE),
                               labels = c('Se identifica con algun partido y/o coalicion politica', 'No se identifica con ningun partido ni coalicion politica'))

etiquetas.grafico2.1 <- datos2.1 %>% 
    group_by(idnull, ola) %>% 
    summarise(porcentaje = sum(porcentaje, na.rm = TRUE)) %>% 
    mutate(idencuesta = 1)

head(datos2.1)
```

```{r gráfico alluvial 2.1: idnull 2 olas}

ggplot(datos2.1, aes(x = ola, fill = idnull, stratum = idnull, 
               alluvium = idencuesta, y = porcentaje)) +
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.grafico2.1, 
              aes(label = scales::percent(porcentaje, accuracy = .1)),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2.75,
              color = rep('white')) +
    ggtitle('Cambio de frecuencias de indentificación con coalición política según año')
```

#2.1 Alluvial para cuatro olas: identificación con coalición política
```{r datos alluvial 2.2: idpol 4 olas, echo=TRUE}
#Ejemplo: [VARIABLE = c05_08] y [VAR_Z = ola]
datos2.2 <- elsoc_long_2016_2019 %>% 
    dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>%
  mutate(idpol = factor(c17,
                          labels = c('Chile Vamos','Nueva Mayoría','Frente Amplio', 'Otra','Ninguna'))) %>%
    dplyr::filter(!is.na(idpol)) %>%
    group_by(idencuesta,idpol, ola) %>%
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>%
    group_by(ola) %>%
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>%
    ungroup()

etiquetas.grafico2.2 <- datos2.2 %>% 
    group_by(idpol,ola) %>% 
    summarise(porcentaje = sum(porcentaje, na.rm = TRUE)) %>% 
    mutate(idencuesta = 1)
head(datos2.2)
```

```{r gráfíco alluvial 2.2: idpol 4 olas}
ggplot(datos2.2, aes(x = ola, fill = idpol, stratum = idpol, 
               alluvium = idencuesta, y = porcentaje)) +
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) + 
    ylab(label = NULL) +
    xlab(label = NULL) + 
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    geom_text(data = etiquetas.grafico2.2, 
              aes(label = scales::percent(porcentaje, accuracy = .1)),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2.75,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias de indentificación con coalición política según año')
```

#2.3 Alluvial para dos o más categorías: situación ocupacional
```{r datos alluvial 2.3: socup}
elsoc_long_2016_2019$socup <- car::recode(elsoc_long_2016_2019$m02,"c(1,2,3) = 1; 7 = 2; 6 = 3; 5 = 4; c(4, 8, 9) = 5")
elsoc_long_2016_2019$socup <- factor(elsoc_long_2016_2019$socup, 
                            labels = c("Trabajo remunerado", "Trabajo doméstico no remunerado", "Desempleado/a", "Jubilado/a o pensionado/a", "Otras categorías"))

datos2.3 <- elsoc_long_2016_2019 %>% 
    dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>%
    dplyr::filter(!is.na(socup)) %>%
    group_by(idencuesta,socup,m0_sexo,ola) %>%
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>%
    group_by(ola,m0_sexo) %>%
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>%
    ungroup()

etiquetas.grafico2.3 <- datos2.3 %>% 
    group_by(socup,ola, m0_sexo) %>% 
    summarise(porcentaje = sum(porcentaje, na.rm = TRUE)) %>% 
    mutate(idencuesta = 1)

head(datos2.3)

```
datos2.3b <- elsoc_long_2016_2019 %>% 
        dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>% 
        dplyr::select(ola, ponderador02, starts_with('d05_')) %>% 
        lapply(sticky::unsticky) %>% data.frame() %>% 
        pivot_longer(cols = starts_with('d05_'))  %>%
        mutate(variable = factor(name,
                             labels = c('Provenir de una familia rica o con muchos recursos', ' Tener un buen nivel de educación', ' Tener ambición', ' El trabajo duro')),
           respuesta = case_when(value == 1 | value == 2 ~ 'Nada o Poco Importante',
                                 value == 3  ~ 'Algo Importante',
                                 value == 4 | value == 5 ~ 'Bastante o Muy Importante')) %>% 
    group_by(ola, variable, respuesta) %>% 
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>% 
    dplyr::filter(!is.na(respuesta)) %>% 
    group_by(ola, variable) %>% 
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>% 
    ungroup()
```{r gráfico alluvial 2.3: socup por sexo}
ggplot(datos2.3, aes(x = ola, fill = socup, stratum = socup, 
               alluvium = idencuesta, y = porcentaje)) +
    ggalluvial::geom_flow(alpha = .66) + 
    ggalluvial::geom_stratum(linetype = 0) +
    scale_y_continuous(labels = scales::percent) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
    facet_grid(.~m0_sexo)+
    geom_text(data = etiquetas.grafico2.3, 
              aes(label = scales::percent(porcentaje, accuracy = .1)),
              position = position_stack(vjust = .5),
              show.legend = FALSE,
              size = 2.75,
              color = rep('white'))+
  ggtitle('Cambio de frecuencias en situación ocupacional para hombres y mujeres')
```


#3.1 Lineas y puntos 

```{r datos linea y puntos 3.1: constitución}
#sjmisc::frq(elsoc_long_2016_2019$conformidad_consti)
#elsoc_long_2016_2019$conformidad_consti <- car::recode(elsoc_long_2016_2019$c26, "c(1,2)=1;c(3)=2;c(4,5)=3")
#elsoc_long_2016_2019$conformidad_consti <- factor(elsoc_long_2016_2019$conformidad_consti, 
                            #labels = c('Disconforme o muy disconforme', 'Indiferente', 'Conforme o muy conforme'))
#elsoc_long_2016_2019$importa_cambiar_consti <- car::recode(elsoc_long_2016_2019$c27, "c(1,2)=1;c(3)=2;c(4,5)=3")
#elsoc_long_2016_2019$importa_cambiar_consti <- factor(elsoc_long_2016_2019$importa_cambiar_consti, 
                            #labels = c('Poco importante o nada importante', 'Algo importante', 'Bastante importante o muy importante'))

elsoc_long_2016_2019$cambiar_consti <- car::recode(elsoc_long_2016_2019$c27, "c(1,2)=1;c(3)=2;c(4,5)=3")
elsoc_long_2016_2019$cambiar_consti <- factor(elsoc_long_2016_2019$cambiar_consti, 
                            labels = c('En desacuendo o totalmente en desacuerdo', 'Ni de acuerdo ni en desacuerdo', 
                                       'De acuerdo o totalmente de acuerdo'))


datos3.1 <- elsoc_long_2016_2019 %>% 
    dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>%
    dplyr::filter(!is.na(cambiar_consti)) %>%
    group_by(idencuesta,cambiar_consti,ola) %>%
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>%
    group_by(ola) %>%
    mutate(n2 = sum(n1, na.rm = TRUE), porcentaje = n1/n2) %>%
    ungroup()

etiquetas.grafico3.1 <- datos3.1 %>% 
    group_by(ola,cambiar_consti) %>% 
    summarise(porcentaje = sum(porcentaje, na.rm = TRUE)) %>% 
    mutate(idencuesta = 1)

```

```{r}
ggplot(etiquetas.grafico3.1,aes(y = porcentaje, x = ola, color = cambiar_consti, group = cambiar_consti,
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
    geom_line(size = 1) +
    geom_point(size = 1.8) +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, .4)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_color_viridis_d(begin = .2, end = .5, direction = 1, option = 'viridis') +
    geom_text(vjust = -0.8,
    posilinetion = position_dodge(width = .9),
    size= 2.75) +
    theme(legend.position = 'top',
          legend.title = element_blank())
```

