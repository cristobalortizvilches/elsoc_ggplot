---
title: 'Visualización Graficos Barra'
author: "Elisa Salas"
date: "28 de mayo 2021"
output:
  html_document: default
  pdf_document:
    toc: no
  word_document:
    toc: no
---

```{r setup, include=FALSE}
# Este es el chunk de setup, opciones generales de chunks, se recomienda!

knitr::opts_chunk$set(cache=FALSE, # guarda renderizaciones parciales, ahorra tiempo
                      warning = FALSE, # evita publicar advertencias
                      message = FALSE) # evita publicar mensajes

Sys.setlocale("LC_ALL","ES_ES.UTF-8") # para temas de caracteres en español, recomendable
```

```{r library, include=FALSE}
library(pacman)
pacman::p_load(stringr,tidyverse,broom,cowplot,ggplot2,survey)
```

```{r Cargar BBDD}
remove(list = ls())
getwd()
load("../1_input/data/elsoc_long.RData")

elsoc_long$conf_presi_rec  <- car::recode(elsoc_long$conf_presi,"c('Nada')= 1;c('Poco','Algo')=2 ;c('Bastante','Mucho')= 3")
elsoc_long$conf_presi_rec  <- factor(elsoc_long$conf_presi_rec,levels=c("1","2","3"), labels = c("Nada","Poco o Algo","Bastante o Mucho"))

elsoc_diseno <- svydesign(ids = ~segmento, 
                          strata = ~estrato, 
                          weights = ~ponderador02, 
                          nest = TRUE,
                          data = elsoc_long)
```

### a. Gráficos de barra

#### a.1 Gráficos de barra que relacionan dos variables

En esta sección aprenderá a realizar gráficos de barra simples para datos longitudinales. Esta sección elabora análisis para una sola variable categórica, la cual se puede agrupar bajo una variable categoría.

Paso 1: En caso de querer crear una variable nueva a partir de otras variables en el listado, debe realizarlo antes de los pasos a continuación.

Paso 2: Crear una tabla simplificada que agrupa la variable a analizar por otra variable de interés

- Rellenar nombre de variable de interés *[VARIABLE]* y agurpación de interés *[VAR_Z]*
```{r tabla_datos_gráfico, echo=TRUE}
#Ejemplo: [VARIABLE = conf_presi] y [VAR_Z = ola]
a <- data.frame((svytable(~conf_presi + ola, elsoc_diseno, round = F)))

b <- a %>% group_by(ola) %>% transmute(porcentaje=Freq/sum(Freq)) 
b$ola <- NULL
a$Freq <- NULL

datos.grafico<- cbind(a,b)

```

Paso 3: Revisar la tabla recién creada
```{r revisión, echo=TRUE}
head(datos.grafico)
```

Luego de hacer esos 3 pasos, se realizan 5 tipos de gráfico que relacionan dos variables:

(1) Variable categórica de interés *[VARIABLE]*

(2) Variable que agrupa (ej: ola, tramo de edad, sexo, ciudad, zona, etc..) *[VAR_Z]*

##### a.1.1 Grafico de Barras con X = 'Categoría' 
```{r bar_x_categoría, echo=TRUE}
datos.grafico %>% 
    ggplot(aes(y = porcentaje, x = conf_presi, fill = ola, 
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
    geom_col(position= 'dodge2') +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    facet_grid(.~ola)+  #eliminar si se quiere todo en un mismo gráfico
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    ggtitle('Confianza en el Presidente(a) de la República según año')
```

##### a.1.2 Grafico de Barras con X = 'Ola' - Dodge
```{r bar_x_ola_dodge, echo=TRUE}
datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = conf_presi, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'dodge2') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_dodge(width = .9),
            size= 2.75) +
  theme(legend.position = 'top',
        legend.title = element_blank()) +
ggtitle('Confianza en el Presidente(a) de la República según año')
```

##### a.1.3 Grafico de Barras con X = 'Ola' - Stack
```{r bar_x_ola_stack, echo=TRUE}
datos.grafico %>% 
  ggplot(aes(y = porcentaje, x = ola, fill = conf_presi, 
             label = as.character(scales::percent(porcentaje, accuracy = .1)))) + 
  theme_bw() + 
  geom_col(position = 'Stack') +
  scale_y_continuous(labels = scales::percent,
                     limits = c(0, 1)) +
  ylab(label = NULL) +
  xlab(label = NULL) +
  scale_fill_viridis_d(begin = 0, end = .85, direction = -1, option = 'viridis') +
  geom_text(vjust = -0.8,
            position = position_stack(vjust= .1),
            size= 2.55) +
  ##eliminar el texto porque la categoría "Mucho" era muy pequeña y se corría el texto
  theme(legend.position = 'top',
        legend.title = element_blank()) +
  ggtitle('Confianza en el Presidente(a) de la República cada año')
```

#### a.1 Gráficos de barra que relacionan dos variables

##### a.2.1 Dos categorías de agrupación: Edad y Ola
```{r}
c <- data.frame(svytable(~conf_presi + ola + edad, elsoc_diseno, round = T))

d <- c %>% group_by(edad) %>% transmute(porcentaje=Freq/sum(Freq)) 
d$edad <- NULL
c$Freq <- NULL

datos.grafico2<- cbind(c,d)

datos.subset <- droplevels(subset(datos.grafico2, datos.grafico2$edad == '18-29'))

datos.subset %>% 
    ggplot(aes(y = porcentaje, x = ola, fill = conf_presi, 
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
    geom_col(position = 'dodge2') +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 0.5)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    ggtitle('Confianza en el Presidente(a) de la República el año 2019')
```


##### a.1.4 Grafico de Barras con X = 'Categoría' en Ola = 'año'
```{r bar_x_cat_por_ola, echo=TRUE}
datos.subset <- droplevels(subset(datos.grafico, datos.grafico$ola == '2019'))

datos.subset %>% 
    ggplot(aes(y = porcentaje, x = conf_presi, fill = conf_presi, 
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
    geom_col(position = 'dodge2') +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position = 'top',
          legend.title = element_blank()) +
    ggtitle('Confianza en el Presidente(a) de la República el año 2019')
```


##### a.1.6 Grafico de Barras con X = 'Ola' en Categoría = 'Nada o Poco'
```{r recode_categoria, include=FALSE}
e <- data.frame(svytable(~conf_presi_rec + ola, elsoc_diseno, round = T))

f <- e %>% group_by(ola) %>% transmute(porcentaje=Freq/sum(Freq)) 
f$ola <- NULL
e$Freq <- NULL

datos.grafico3<- cbind(e,f)
```

```{r bar_x_ola_por_cat, echo=TRUE}
datos.subset <- droplevels(subset(datos.grafico3, datos.grafico3$conf_presi_rec == 'Poco o Algo'))

datos.subset %>% 
    ggplot(aes(y = porcentaje, x = ola, fill = conf_presi_rec, 
               label = as.character(scales::percent(porcentaje, accuracy = .1)))) +
  theme_bw() + 
    geom_col(width = 0.5, position = "dodge2") +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position="none") +
    ggtitle('Responde "Nada o Poco" en confianza en el Presidente(a) de la República según año')
```


#### Quiero agregar los gráficos del estilo: aumenta, se mantiene, disminuye


# PARTE 2: Gráfico de barras para más de dos variables
En este instructivo aprenderá a realizar gráficos de barra más complejos para datos longitudinales. Esta sección elabora análisis para graficar tres o más variables en un mismo gráfico. 

Paso 1: Seleccionar y recodificar las variables que se analizarán

```
## Grafico de Barras por cada variable X = 'Categoría'
```{r creo que final}
datos.grafico <- elsoc_long %>% 
        dplyr::filter(tipo_atricion == 1 & tipo_caso != 2) %>% 
        dplyr::select(ola, ponderador02, starts_with('d05_')) %>% 
        lapply(sticky::unsticky) %>% data.frame() %>% 
        pivot_longer(cols = starts_with('d05_'))  %>%
        mutate(variable = factor(name,
                             labels = c(' Provenir de una familia rica o con muchos recursos', ' Tener un buen nivel de educación', ' Tener ambición', ' El trabajo duro')),
           respuesta = case_when(value == 1 | value == 2 ~ 'Nada o Poco Importante',
                                 value == 3  ~ 'Algo Importante',
                                 value == 4 | value == 5 ~ 'Bastante o Muy Importante')) %>% 
    group_by(ola, variable, respuesta) %>% 
    summarise(n1 = sum(ponderador02, na.rm = TRUE)) %>% 
    dplyr::filter(!is.na(respuesta)) %>% 
    group_by(ola, variable) %>% 
    mutate(n2 = sum(n1, na.rm = TRUE), Freq = n1/n2) %>% 
    ungroup()
```

```{r graficando, echo=TRUE}
datos.subset <- droplevels(subset(datos.grafico, datos.grafico$respuesta == 'Bastante o Muy Importante'))

datos.subset %>% 
    ggplot(aes(y = Freq, x = ola, fill = variable, 
               label = as.character(scales::percent(Freq, accuracy = .1)))) +
  theme_bw() + 
    geom_col(width = 0.5, position = "dodge2") +
    scale_y_continuous(labels = scales::percent,
                       limits = c(0, 1)) +
    ylab(label = NULL) +
    xlab(label = NULL) +
    scale_fill_viridis_d(begin = .33, end = .66, direction = -1, option = 'viridis') +
    facet_grid(.~variable) + 
    geom_text(vjust = -0.8,
              position = position_dodge(width = .9),
              size= 2.75) +
    theme(legend.position="none") +
    ggtitle('Responde "Bastante o Muy Importante" según año')
```

